---
title: "RT Models"
author: "Julia Schwarz"
date: "14/01/2022"
output:
  html_document:
    df_print: paged
  pdf_document: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
info <- rstudioapi::versionInfo()
info

# check what version of RStudio is in use
if (info$version >= "1.4") {
  # code specific to versions of RStudio 1.4 and newer
}

# check whether RStudio Desktop or RStudio Server is being used
if (info$mode == "desktop") {
  # code specific to RStudio Desktop
}

# Get the citation
info$citation
```



## Packages

```{r packages, include=FALSE}
library(LMERConvenienceFunctions)
library(lme4)
packageVersion('lme4')
library(ggplot2)
library(lattice)
library(car)
library(lmerTest)
packageVersion('lmerTest')
library(rcompanion)
library(MuMIn)
library(sjPlot)
library(sjlabelled)
library(sjmisc)
library(moments)
library(Hmisc)
library(dplyr)
library(emmeans)
library(performance)
library(effects)
library(stargazer)
library(gtsummary)
library(qwraps2)
library(webshot)
emm_options(pbkrtest.limit = 6000)
emm_options(lmerTest.limit = 6000)
```



## Data File

Pre-processed data file, extreme values, practice trials, and incorrect responses all removed. 5653 observations (old set had 3560 observations). 

```{r load data, echo=FALSE}
data<-read.delim("220118_fulldata_cleaned.txt", sep="\t", header=T) 
```



## Variable Prep

```{r variables, echo=FALSE}
# Random 
data$SUBJECT <- as.factor(data$SUBJECT)
data$ITEM <- as.factor(data$ITEM) #this represents the different sentences (H & L), NOT the different targets

# Outcome Var
data$RT <- as.numeric(data$RT) #RT from the end of the sentence

# Outcome Var zscored/scaled
data$RT_z <- scale(data$RT, center = TRUE, scale = TRUE)

# Fixed Main Effects
data$AUDIO <- factor(data$AUDIO, levels=c("aNM","aM"))
data$VIDEO <- factor(data$VIDEO, levels = c("vNM", "vM"))
data$PREDICT <- factor(data$PREDICT, levels = c("H", "L"))
data$AGE <- as.numeric(data$AGE)
data$AGE <- round(data$AGE, digits = 2)
data$TRIAL <- as.numeric(data$TRIAL)
#data$BLOCK <- as.numeric(data$BLOCK)
data$GROUP <- as.factor(data$GROUP) #adults vs children

# Fixed Effects Contrast Coded
contrasts(data$AUDIO) <- contr.sum(2)
contrasts(data$AUDIO)
contrasts(data$VIDEO) <- contr.sum(2)
contrasts(data$VIDEO)
contrasts(data$PREDICT) <- contr.sum(2)
contrasts(data$PREDICT)
contrasts(data$GROUP) <- contr.sum(2)
contrasts(data$GROUP)

# Fixed Effects Centered; "if in doubt, center"
data$AGE_c <- scale(data$AGE, scale = FALSE, center = TRUE)
data$TRIAL_c <- scale(data$TRIAL, scale = FALSE, center = TRUE)
#data$BLOCK <- scale(data$BLOCK,scale = FALSE, center = TRUE)
# Alternative Centering
# data <- mutate(data, GROUP = AGE - mean(AGE, na.rm = TRUE)) ####this doesn't work anymore! why?
# data <- mutate(data, TRIAL_c2 = TRIAL - mean(TRIAL, na.rm = TRUE))

# Other
data$ACC <- as.factor(data$ACC) #1==correct
data$CONDITION <- as.factor(data$CONDITION)
data$LIST <- as.factor(data$LIST)
data$SEX <- as.factor(data$sex)

# Alternative Contrast Coding
# contrasts(data$GROUP) <- c(-1,+1)
# contrasts(data$AUDIO) <- c(-0.5,+0.5)
# contrasts(data$VISUAL) <- c(-0.5,+0.5)
# contrasts(data$PREDICT) <- c(-0.5,+0.5)

```

```{r}
data %>%
  group_by(GROUP,PREDICT,AUDIO,VIDEO) %>%
  summarise(n=n(), mean = round(mean(RT)))
#Role of semantic: 95 for adults; 62 for children
#Role of audio: 19 for adults; 23 for children
#Role of vedio: 21 for adults; 20 for children
#Interaction in adults: all: 441-404 =37; 407-400 (7)
#                         H: 372-364; 378
```


## Subsets

```{r subsets, include=TRUE}

adults <- subset(data, data$group == 'a') #2903
summary(adults$AGE)
contrasts(adults$AUDIO) #contrasts are kept in subsets

children <- subset(data, data$group == 'c') #2750
summary(children$AGE)
hist(children$AGE)
young <- subset(children, children$AGE<11.0) #1485
old <- subset(children, children$AGE>10.9) #1265
1485+1265

```




## Full Data Model

### Maximal Model

We first fitted a model to the complete data set.


### Testing Random Structure

First, the random effects SUBJECT and ITEM were tested. Both SUBJECT and ITEM contributed significantly to the model fit and were retained in all subsequent models. 

```{r, random intercept, include=FALSE}
# random slopes as well
lmm.random1 <- lmerTest::lmer(RT ~ 
                               
                            (1 | SUBJECT) + 
                            (1 | ITEM),
                          
                           data, 
                           lmerControl(optimizer = "bobyqa") , 
                           REML=F, na.action=na.omit)

lmm.random2 <- lmerTest::lmer(RT ~ 
                               
                            (1 | SUBJECT),
                          
                           data, 
                           lmerControl(optimizer = "bobyqa") , 
                           REML=F, na.action=na.omit)

lmm.random3 <- lmerTest::lmer(RT ~ 
                               
                            (1 | ITEM),
                          
                           data, 
                           lmerControl(optimizer = "bobyqa") , 
                           REML=F, na.action=na.omit)

anova(lmm.random1, lmm.random2) #sig.
anova(lmm.random1, lmm.random3) #sig.

```

Random slopes were tested based on theoretical motivation, while avoiding singularity and convergence issue due to overfitting.

```{r, random slopes by subjects, include=FALSE}

lmm.slope1 <- lmerTest::lmer(RT ~ 
                               
                            (VIDEO+PREDICT | SUBJECT) + 
                            (1 | ITEM),
                          
                           data, 
                           lmerControl(optimizer = "bobyqa") , 
                           REML=F, na.action=na.omit)

lmm.slope2 <- lmerTest::lmer(RT ~ 
                               
                            (VIDEO | SUBJECT) + 
                            (1 | ITEM),
                          
                           data, 
                           lmerControl(optimizer = "bobyqa") , 
                           REML=F, na.action=na.omit)

lmm.slope3 <- lmerTest::lmer(RT ~ 
                               
                            (PREDICT | SUBJECT) + 
                            (1 | ITEM),
                          
                           data, 
                           lmerControl(optimizer = "bobyqa") , 
                           REML=F, na.action=na.omit)

# Singularity + audio less likely to make theoretical difference
lmm.slope4 <- lmerTest::lmer(RT ~ 
                               
                            (AUDIO+PREDICT | SUBJECT) + 
                            (1 | ITEM),
                          
                           data, 
                           lmerControl(optimizer = "bobyqa") , 
                           REML=F, na.action=na.omit)


anova(lmm.random1, lmm.slope1) #sig.
anova(lmm.slope1, lmm.slope2) #p=2.51e-05
anova(lmm.slope1, lmm.slope3) #p=0.02969

```

The final random structure was (VIDEO+PREDICT | SUBJECT) + (VIDEO+AUDIO | ITEM)

```{r, random sloped by items}

lmm.slope5 <- lmerTest::lmer(RT ~ 
                               
                            (VIDEO+PREDICT | SUBJECT) + 
                            (VIDEO+AUDIO | ITEM),
                          
                           data, 
                           lmerControl(optimizer = "bobyqa") , 
                           REML=F, na.action=na.omit)

lmm.slope6 <- lmerTest::lmer(RT ~ 
                               
                            (VIDEO+PREDICT | SUBJECT) + 
                            (1+TRIAL_c | SUBJECT) +
                            (1 | ITEM),
                          
                           data, 
                           lmerControl(optimizer = "bobyqa") , 
                           REML=F, na.action=na.omit) #slope8 failed to converge; other trial tests also struggle

anova(lmm.slope1, lmm.slope5) #sig
anova(lmm.slope5, lmm.slope6) 

```


### Testing Fixed Structure

6 interactions and 5 main effects (sum contrast coded) were included in the maximal model structure (see below).
The model was then optimized with the step function (checked against manual reduction). 

```{r, full start model}
lmm.all <- lmerTest::lmer(RT ~ 
                            AUDIO:VIDEO +
                            AUDIO:GROUP +
                            VIDEO:GROUP +
                            AUDIO:PREDICT +
                            VIDEO:PREDICT +
                            GROUP:PREDICT +
                            
                            GROUP +
                            PREDICT +
                            VIDEO +
                            AUDIO +
                            TRIAL_c +
                            
                            (1+VIDEO+PREDICT | SUBJECT) + 
                            (1+VIDEO+AUDIO | ITEM),
                          
                           data, 
                           lmerControl(optimizer = "bobyqa") , 
                           REML=F, na.action=na.omit)
summary(lmm.all)
```


```{r optimize, include=FALSE}
# optimize model w step function: results the same as tested manually (separate file)

step_object<-step(lmm.all, 
                  ddf = "Satterthwaite", 
                  alpha.random = 0.1, 
                  alpha.fixed = 0.05, 
                  reduce.fixed = TRUE, 
                  reduce.random = TRUE)
stepmodel<-get_model(step_object)
summary(stepmodel)
```


optimizer (bobyqa) convergence code: 0 (OK)
boundary (singular) fit: see ?isSingular

--> simplify random structure

### Optimized Model Summary (all data):

The optimized full data model included subject and item random intercepts and predictability as a random slope. The fixed effects included three significant interactions between (1) acoustic mask effect and visual mask effect, (2) acoustic mask effect and predictability effect, and (3) between age and predictability effect. Predictability, visual mask effect, acoustic mask effect, age, and trial order were main effects. 

```{r simplified model}
lmm.all.optimized <- lmerTest::lmer(RT ~ 
                            AUDIO:VIDEO +

                            
                            AUDIO:PREDICT +
                            
                            GROUP:PREDICT +
                            
                            GROUP +
                            PREDICT +
                            VIDEO +
                            AUDIO +
                            TRIAL_c +
                            
                            (1+PREDICT | SUBJECT) + 
                            (1 | ITEM),
                          
                           data, 
                           lmerControl(optimizer = "bobyqa") , 
                           REML=T, na.action=na.omit)
summary(lmm.all.optimized)
tab_model(lmm.all.optimized)

res <- residuals(lmm.all.optimized)
qqnorm(res)
qqline(res)
skewness(res)
hist(res, breaks=100)
plot(fitted(lmm.all.optimized), res)
```

Note: In an exploratory fashion, when GROUP:PREDICT:AUDIO is added to the full model, the three-way interaction does not survive model reduction. 




### Optimized Model plotted (all data)

```{r, echo=FALSE}
plot_model(lmm.all.optimized, type = "std", show.values = TRUE, value.offset = .3, sort.est = TRUE, title = "Fixed Factor Estimates of Optimized Full Data Model")
```

```{r post hoc}
# For the overall model, only run post-hoc including group variable.
# Predict is significant for both group, only at differen size
emmeans(lmm.all.optimized, pairwise~PREDICT|GROUP,p.adjust.method = "bonferroni") 
plot(allEffects(lmm.all.optimized))
emmip(lmm.all.optimized,GROUP ~ PREDICT)
emmeans(lmm.all.optimized, pairwise~AUDIO*VIDEO,p.adjust.method = "bonferroni") 
```



## Adults

### Adults Start Model

Adult and Child data models followed the same analysis pipeline, starting with the same maximal model (incl. age?).

```{r, full adult start model}
lmm.adults <- lmerTest::lmer(RT ~ 
                            AUDIO:VIDEO +
                            AUDIO:AGE_c +
                            VIDEO:AGE_c +
                            AUDIO:PREDICT +
                            VIDEO:PREDICT +
                            AGE_c:PREDICT +
                            
                            AGE_c +
                            PREDICT +
                            VIDEO +
                            AUDIO +
                            TRIAL_c +
                            
                            (1+PREDICT | SUBJECT) + 
                            (1 | ITEM),
                          
                           adults, 
                           lmerControl(optimizer = "bobyqa") , 
                           REML=F, na.action=na.omit)
summary(lmm.adults)
```

### Optimizing

```{r adults optimize, include=FALSE}
step_object_a<-step(lmm.adults, 
                  ddf = "Satterthwaite", 
                  alpha.random = 0.1, 
                  alpha.fixed = 0.05, 
                  reduce.fixed = TRUE, 
                  reduce.random = TRUE)
stepmodel.a<-get_model(step_object_a)
summary(stepmodel.a)
```




### Summary Optimized Adult Model

The optimized adult model with random intercepts for subject and item included a significant interaction between acoustic mask effect and target predictability effect, and a significant interaction between acoustic and visual mask effect, as well as the main effects predictability, visual mask effect, and acoustic mask effect.

```{r, summary adults, echo=FALSE}
lmm.adults.optimized <- lmerTest::lmer(RT ~ 
                            AUDIO:VIDEO +
                            AUDIO:PREDICT +
                            
                            
                            AUDIO +
                            VIDEO +
                            PREDICT +
                            TRIAL_c +
                               
                            (1 | SUBJECT) + 
                            (1 | ITEM),
                          
                           adults, 
                           lmerControl(optimizer = "bobyqa") , 
                           REML=T, na.action=na.omit)
tab_model(lmm.adults.optimized)

res2 <- residuals(lmm.adults.optimized)
qqnorm(res2)
qqline(res2)
skewness(res2)
hist(res2, breaks=100)
plot(fitted(lmm.adults.optimized), res2)
```



### Adult Model Fixed Effects Plotted

```{r, adults fixed effect, echo=FALSE}
plot_model(lmm.adults.optimized, type = "std", show.values = TRUE, value.offset = .3, sort.est = TRUE, title = "Fixed Factor Estimates of Optimized Adult Data Model")
```

```{r adults post-hoc}
emmeans(lmm.adults.optimized, pairwise~AUDIO*VIDEO,p.adjust.method = "bonferroni") 
emmeans(lmm.adults.optimized, pairwise~AUDIO*PREDICT,p.adjust.method = "bonferroni") 
plot(allEffects(lmm.adults.optimized))
```



## Children

### Children Start Model

```{r, full children start model}
lmm.children <- lmerTest::lmer(RT ~ 
                            AUDIO:VIDEO +
                            AUDIO:PREDICT +
                            VIDEO:PREDICT +
                            AGE_c:PREDICT +
                            
                            PREDICT +
                            VIDEO +
                            AUDIO +
                            TRIAL_c +
                            
                            (PREDICT | SUBJECT) + 
                            (1 | ITEM),
                          
                           children, 
                           lmerControl(optimizer = "bobyqa") , 
                           REML=F, na.action=na.omit)
summary(lmm.children)
```

### Optimizing

The child model optimized through the step function only included the main effects predictability and visual mask effect. For comparison reasons, however, the summarized model below includes the same predictors as the adult model.

```{r children optimize, include=FALSE}
step_object_c<-step(lmm.children, 
                  ddf = "Satterthwaite", 
                  alpha.random = 0.1, 
                  alpha.fixed = 0.05, 
                  reduce.fixed = TRUE, 
                  reduce.random = TRUE)
stepmodel.c<-get_model(step_object_c)
summary(stepmodel.c)
```




### Summary Optimized Child Model

The optimized child model had 

NOTE: Changes to the random slopes does not change the best model fit. 


```{r, summary children, echo=FALSE}
lmm.children.optimized <- lmerTest::lmer(RT ~ 
                            AUDIO +
                            VIDEO +
                            PREDICT +
                            TRIAL_c +
                               
                            (PREDICT | SUBJECT) + 
                            (1 | ITEM),
                          
                           children, 
                           lmerControl(optimizer = "bobyqa") , 
                           REML=T, na.action=na.omit)
tab_model(lmm.children.optimized)

res3 <- residuals(lmm.children.optimized)
qqnorm(res3)
qqline(res3)
skewness(res3)
hist(res3)
```

### Child Model Fixed Effects Plotted

```{r, children fixed effect, echo=FALSE}
plot_model(lmm.children.optimized, type = "std", show.values = TRUE, value.offset = .3, sort.est = TRUE, title = "Fixed Factor Estimates of Optimized Child Data Model")
```

```{r children post-hoc}
#emmeans(lmm.children.optimized, pairwise~AUDIO*VIDEO) 
#emmeans(lmm.children.optimized, pairwise~AUDIO*PREDICT) 
plot(allEffects(lmm.children.optimized))
emmip(lmm.children.optimized,VIDEO ~ AUDIO)
emmip(lmm.children.optimized,PREDICT ~ AUDIO)
```


## Blockorder Analysis - Do participants improve over time? 

Filter data for conditions with full mask on (aM+vM) and full mask off (aNM+vNM). **2815** observations. 

```{r mask_data}
mask_data <- subset(data, (data$CONDITION != 'aNMvM'|data$CONDITION != 'aMvNM'))

mask_data$CONDITION <- factor(mask_data$CONDITION, levels=c('aNMvNM','aMvM'))
contrasts(mask_data$CONDITION) <- contr.sum(2)
contrasts(mask_data$CONDITION)
mask_data$BLOCK <- as.numeric(mask_data$BLOCK)
mask_data$BLOCK <- scale(mask_data$BLOCK, scale = FALSE, center = TRUE)
table(mask_data$BLOCK)

#mask_data$BLOCK <- factor(mask_data$BLOCK, levels = c('1','4'))
#contrasts(mask_data$BLOCK) <- contr.sum(2)
#contrasts(mask_data$BLOCK)
```

### Maximal Model 

```{r improve start}
lmm.improve <- lmerTest::lmer(RT ~ 
                       BLOCK:CONDITION:GROUP +
                       BLOCK:CONDITION +
                       BLOCK:GROUP +
                       CONDITION:GROUP+
                         
                       BLOCK +
                       CONDITION +
                       GROUP +
    
                       (1 | SUBJECT) + 
                       (1 | ITEM),
                          
                           mask_data, 
                           lmerControl(optimizer = "bobyqa") , 
                           REML=T, na.action=na.omit)
summary(lmm.improve)
```

```{r improve start}
lmm.improve <- lmerTest::lmer(RT ~ 
                       TRIAL_c:CONDITION:GROUP +
                       TRIAL_c:CONDITION +
                       TRIAL_c:GROUP +
                       CONDITION:GROUP+
                         
                       TRIAL_c +
                       CONDITION +
                       GROUP +
    
                       (1 | SUBJECT) + 
                       (1 | ITEM),
                          
                           mask_data, 
                           lmerControl(optimizer = "bobyqa") , 
                           REML=T, na.action=na.omit)
summary(lmm.improve)
```

### Optimizing

```{r improve optimize, include=FALSE}
step_object_i<-step(lmm.improve, 
                  ddf = "Satterthwaite", 
                  alpha.random = 0.1, 
                  alpha.fixed = 0.05, 
                  reduce.fixed = TRUE, 
                  reduce.random = TRUE)
stepmodel.i<-get_model(step_object_i)
summary(stepmodel.i)
```

### Optimized Model

```{r improve final}
lmm.improve.optimized <- lmerTest::lmer(RT ~ 
                       TRIAL_c:CONDITION +
                       TRIAL_c +
                       CONDITION +
    
                       (1 | SUBJECT) + 
                       (1 | ITEM),
                          
                           mask_data, 
                           lmerControl(optimizer = "bobyqa") , 
                           REML=T, na.action=na.omit)
tab_model(lmm.improve.optimized)
```



```{r block model}
lmm.block <- lmerTest::lmer(RT ~ 
                       BLOCK:CONDITION +
                       BLOCK+
                       CONDITION +
    
                       (1 | SUBJECT) + 
                       (1 | ITEM),
                        
                           subset(mask_data), 
                           lmerControl(optimizer = "bobyqa") , 
                           REML=T, na.action=na.omit)
tab_model(lmm.block)
plot(allEffects(lmm.block))
#emmeans(lmm.block, pairwise ~BLOCK|CONDITION, p.adjust.method = "bonferroni") # now block is numeric
plot_model(lmm.block, type = "int")
# CONDITION is the categorical IV and BLOCK is the MV
# IN this way we do ee that the difference between conditions get no significant
mylist <- list(BLOCK = c(-2,-1, 0,1,2,3,4), CONDITION = c("aNMvNM", "aMvM"))
emcontcat<-emmeans(lmm.block,~ CONDITION*BLOCK, at = mylist)
contrast(emcontcat, "pairwise", by = "BLOCK")

```


### tab model
```{r}
tab_model(lmm.adults.optimized,lmm.children.optimized)

tab_model(lmm.adults.optimized,lmm.children.optimized, pred.labels = c("Intercept","Acoustic Mask", "Visual Mask","Cloze Probability","Trial Order","Acoustic * Visual", "Acoustic * Cloze Probability"),
          dv.labels = c("Adults", "Children"),
          file = "figure/220209threeregressions.html")
webshot("figure/220209threeregressions.html", "figure/220209threeregressions.png")


```



### Plot Trials by Condition and by Group

```{r plot trials}
Blockdata <- groupwiseMean(RT ~ GROUP + CONDITION + BLOCK,
                           data   = mask_data,
                           conf   = 0.95,
                           digits = 3)
as.data.frame(Blockdata)
write.table(Blockdata, "220114_Blockdata.txt", sep="\t", row.names=FALSE)
```





### Model plot (interactions)
```{r}
emmeans(lmm.all.optimized, pairwise~VIDEO*AUDIO|GROUP)
plot(allEffects(lmm.all.optimized))

```



```{r}
emmeans(lmm.adults.optimized, pairwise~AUDIO*VIDEO|PREDICT)
plot(allEffects(lmm.adults.optimized))
```

```{r}
lmm.children.optimized <- lmerTest::lmer(RT ~ 
                            AUDIO +
                            VIDEO +
                            PREDICT +
                            TRIAL_c +
                            AUDIO:VIDEO +
                               
                            (PREDICT | SUBJECT) + 
                            (1 | ITEM),
                          
                           children, 
                           lmerControl(optimizer = "bobyqa") , 
                           REML=T, na.action=na.omit)
emmeans(lmm.children.optimized, pairwise~AUDIO*VIDEO|PREDICT)
plot(allEffects(lmm.children.optimized))
```





