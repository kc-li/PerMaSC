---
title: "PerMaSC accuracy"
author: "Jasper Sim Hong" ; edited by: "Julia Schwarz"
date: "15/01/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages, include=FALSE}

library(ggplot2)
library(dplyr)
library(tidyr)
library(lmerTest)
library(lme4)
library(performance)
library(sjPlot)
library(jtools)
library(car)
library(emmeans)
library(patchwork)

options(scipen = 100)
```

## Data

```{r data}
data<-read.delim("220117_errordata.txt", sep="\t", header=T)
table(data$ACC) 
168/(5778+168) # error rate
```

## Variable Prep

```{r variables, echo=FALSE}
# Random 
data$SUBJECT <- as.factor(data$SUBJECT)
data$ITEM <- as.factor(data$ITEM) #this represents the different sentences (H & L), NOT the different targets

# Outcome Var
data$ACC <- as.factor(data$ACC) #1==correct

# RT
data$RT <- as.numeric(data$RT) #RT from the end of the sentence
data$RT_z <- scale(data$RT, center = TRUE, scale = TRUE)

# Fixed Main Effects
data$AUDIO <- factor(data$AUDIO, levels=c("aNM","aM"))
data$VIDEO <- factor(data$VIDEO, levels = c("vNM", "vM"))
data$PREDICT <- factor(data$PREDICT, levels = c("H", "L"))
data$AGE <- as.numeric(data$AGE)
data$AGE <- round(data$AGE, digits = 2)
data$TRIAL <- as.numeric(data$TRIAL)
data$GROUP <- as.factor(data$GROUP) #adults vs children

data$ACOUSTIC <- factor(data$AUDIO, levels = c("aNM","aM"), labels = c("-Acoustic Mask", "+Acoustic Mask")) 
data$VISUAL <- factor(data$VIDEO, levels = c("vNM","vM"), labels = c("-Visual Mask", "+Visual Mask"))
data$PREDICTABILITY <- factor(data$PREDICT, levels = c("H","L"), labels = c("High", "Low"))

# Fixed Effects Contrast Coded
contrasts(data$AUDIO) <- contr.sum(2)
contrasts(data$AUDIO)
contrasts(data$VIDEO) <- contr.sum(2)
contrasts(data$VIDEO)
contrasts(data$PREDICT) <- contr.sum(2)
contrasts(data$PREDICT)
contrasts(data$GROUP) <- contr.sum(2)
contrasts(data$GROUP)

# Fixed Effects Centered; "if in doubt, center"
data$AGE_c <- scale(data$AGE, scale = FALSE, center = TRUE)
data$TRIAL_c <- scale(data$TRIAL, scale = FALSE, center = TRUE)

# Other
data$CONDITION <- as.factor(data$CONDITION)
data$BLOCK <- as.factor(data$BLOCK)
data$LIST <- as.factor(data$LIST)
data$SEX <- as.factor(data$sex)
```

# Summary statistics
```{r}
# With group_by(GROUP) or not
data %>%
  group_by(VIDEO,AUDIO,PREDICT,GROUP) %>%
  summarise(n=n(),error_condition = round(((1- sum(accuracy)/n())*100),2))

data %>%
  filter(CONDITION != "aMvM" & PREDICT == "L") %>%
  group_by(GROUP,CONDITION) %>%
  summarise(n=n(),error_condition = round(((1- sum(accuracy)/n())*100),2))
```
```{r checking token numbers}
# For checking data loss
parlist <- unique(data$parid)
# dput(as.character(parlist)) 
# Using python files to locate
tab1 <- read.delim("checkingtokennum/processed_step1.txt", sep = "\t", header = T)
tab2 <- read.delim("checkingtokennum/processed_step2.txt", sep = "\t", header = T)
# Tab 1 missing c79 - but tab1 is not very informational anyway, so let's skip it.
original = sum(tab2$num_of_intervals) # 6557
# How many deleted because of practice trial or special trials?
# How many are repetitive?
final = nrow(data) # 5946


nrow(tab2) #52 OK!
nrow(data)
6557 - 5946

```



```{r figure prep}
visual <- data %>%
  group_by(GROUP,VISUAL) %>%
  summarise(n=n(),error_rate = round(((1- sum(accuracy)/n())*100),2))
acoustic <- data %>%
  group_by(GROUP,ACOUSTIC) %>%
  summarise(n=n(),error_rate = round(((1- sum(accuracy)/n())*100),2))
predict <- data %>%
  group_by(GROUP,PREDICTABILITY) %>%
  summarise(n=n(),error_rate = round(((1- sum(accuracy)/n())*100),2))

error_plot_individual <- function(data, xaxis){
  ggplot(data, aes({{xaxis}}, error_rate, group = GROUP)) + # the double curly bracket asks for search the variable within the dataframe
    geom_point(size = 3,colour=('#666666')) +
    geom_line(aes(linetype = GROUP),size = 1,colour=('#666666')) +
    coord_cartesian(ylim = c(0, 7)) +
    labs(y = "Inaccurate Responses per Condition (%)", linetype = "Group") +
    theme_classic() +
    theme(axis.text.x = element_text(size = 12), # for x label text
        axis.text.y = element_text(size = 12), 
        axis.title.x = element_text(size = 15), # for x axis title
        axis.title.y = element_text(size = 15),
        legend.text = element_text(size=15), # for legend size
        legend.title = element_text(size=15)# for legend title
        )
}

p1_acoustic <- error_plot_individual(acoustic, ACOUSTIC) +
  labs(x = "Acoustic")
p1_visual <- error_plot_individual(visual, VISUAL) +
  labs(x = "Visual")
p1_predict <- error_plot_individual(predict, PREDICTABILITY)+
  labs(x = "Cloze Probability")

# patch work package
remove_y <- theme(
  axis.title.y = element_blank(),
  axis.ticks.y = element_blank(),
  axis.text.y = element_blank()
)
p1_acoustic_adjust <- p1_acoustic 
p1_visual_adjust <- p1_visual + remove_y 
p1_predict_adjust <- p1_predict + remove_y
p.combine <- p1_acoustic_adjust+p1_visual_adjust+p1_predict_adjust +plot_layout(guides = 'collect')&theme(legend.position = 'bottom')
p.combine
p.combine <- patchwork::patchworkGrob(p.combine)
ggsave("figure/220209_ACC_individual_effect.png", p.combine, width = 10, height = 6)
```


# Full Start Model

# Removed stepwise to allow computation: Video by subject random slope, by item audio slope

```{r group}
glm.complex <- glmer(ACC ~ 
                            AUDIO:VIDEO +
                            AUDIO:PREDICT +
                            GROUP:PREDICT + 
                            AUDIO:GROUP +
                            VIDEO:GROUP +
                            VIDEO:PREDICT +
                            
                            AUDIO +
                            VIDEO +
                            PREDICT +
                            GROUP + 
                            TRIAL_c +
                               
                            (1+PREDICT|SUBJECT)+ #+VIDEO taken out
                            (1+VIDEO|ITEM), #AUDIO+ taken out
                          
                           family = binomial("logit"), 
                           data=data,                      
                           control=glmerControl(optimizer="bobyqa", 
                           optCtrl=list(maxfun=2e5),
                           calc.derivs=FALSE), 
                           na.action=na.omit)
summary(glm.complex)
```

```{r optimize, include=FALSE}
glm.1 <- glmer(ACC ~ 
                            AUDIO:VIDEO +
                            AUDIO:PREDICT +
                            GROUP:PREDICT + 
                            AUDIO:GROUP +
                            VIDEO:GROUP +
                            VIDEO:PREDICT +
                            
                            AUDIO +
                            VIDEO +
                            PREDICT +
                            GROUP + 
                            TRIAL_c +
                               
                            (1+PREDICT|SUBJECT)+ #+VIDEO taken out
                            (1|ITEM), #AUDIO+ taken out #VIDEO
                          
                           family = binomial("logit"), 
                           data=data,                      
                           control=glmerControl(optimizer="bobyqa", 
                           optCtrl=list(maxfun=2e5),
                           calc.derivs=FALSE), 
                           na.action=na.omit)
anova(glm.complex, glm.1) # no significant difference after simplifying the random slope

glm.2 <- glmer(ACC ~ 
                            AUDIO:VIDEO +
                            AUDIO:PREDICT +
                            GROUP:PREDICT + 
                            AUDIO:GROUP +
                            VIDEO:GROUP +
                            VIDEO:PREDICT +
                            
                            AUDIO +
                            VIDEO +
                            PREDICT +
                            GROUP + 
                            TRIAL_c +
                               
                            (1|SUBJECT)+ #PREDICT simplified
                            (1|ITEM), #taken out #VIDEO
                          
                           family = binomial("logit"), 
                           data=data,                      
                           control=glmerControl(optimizer="bobyqa", 
                           optCtrl=list(maxfun=2e5),
                           calc.derivs=FALSE), 
                           na.action=na.omit)
anova(glm.1, glm.2) # no sig. difference
```

```{r optimized glm}
glm.3 <- glmer(ACC ~ 
                            #AUDIO:VIDEO +
                            AUDIO:PREDICT +
                            GROUP:PREDICT + 
                            AUDIO:GROUP +
                            VIDEO:GROUP +
                            VIDEO:PREDICT +
                            
                            AUDIO +
                            VIDEO +
                            PREDICT +
                            GROUP + 
                            TRIAL_c +
                               
                            (1|SUBJECT)+
                            (1|ITEM),
                          
                           family = binomial("logit"), 
                           data=data,                      
                           control=glmerControl(optimizer="bobyqa", 
                           optCtrl=list(maxfun=2e5),
                           calc.derivs=FALSE), 
                           na.action=na.omit)
anova(glm.2, glm.3) #no dif.

glm.4 <- glmer(ACC ~ 
                            #AUDIO:VIDEO +
                            AUDIO:PREDICT +
                            GROUP:PREDICT + 
                            #AUDIO:GROUP +
                            VIDEO:GROUP +
                            VIDEO:PREDICT +
                            
                            AUDIO +
                            VIDEO +
                            PREDICT +
                            GROUP + 
                            TRIAL_c +
                               
                            (1|SUBJECT)+
                            (1|ITEM),
                          
                           family = binomial("logit"), 
                           data=data,                      
                           control=glmerControl(optimizer="bobyqa", 
                           optCtrl=list(maxfun=2e5),
                           calc.derivs=FALSE), 
                           na.action=na.omit)
anova(glm.3, glm.4) #sig. -> keep Audio:Group

glm.5 <- glmer(ACC ~ 
                            #AUDIO:VIDEO + #drop
                            AUDIO:PREDICT +
                            GROUP:PREDICT + 
                            AUDIO:GROUP + #keep
                            #VIDEO:GROUP +
                            VIDEO:PREDICT +
                            
                            AUDIO +
                            VIDEO +
                            PREDICT +
                            GROUP + 
                            TRIAL_c +
                               
                            (1|SUBJECT)+
                            (1|ITEM),
                          
                           family = binomial("logit"), 
                           data=data,                      
                           control=glmerControl(optimizer="bobyqa", 
                           optCtrl=list(maxfun=2e5),
                           calc.derivs=FALSE), 
                           na.action=na.omit)
anova(glm.3, glm.5) #sig. -> keep video:group

glm.6 <- glmer(ACC ~ 
                            #AUDIO:VIDEO + #drop
                            AUDIO:PREDICT +
                            GROUP:PREDICT + 
                            AUDIO:GROUP + #keep
                            VIDEO:GROUP + #keep
                            #VIDEO:PREDICT + #keep
                            
                            AUDIO +
                            VIDEO +
                            PREDICT +
                            GROUP + 
                            TRIAL_c +
                               
                            (1|SUBJECT)+
                            (1|ITEM),
                          
                           family = binomial("logit"), 
                           data=data,                      
                           control=glmerControl(optimizer="bobyqa", 
                           optCtrl=list(maxfun=2e5),
                           calc.derivs=FALSE), 
                           na.action=na.omit)
anova(glm.3, glm.6) #sig. -> keep video:predict

glm.7 <- glmer(ACC ~ 
                            #AUDIO:VIDEO + #drop
                            #AUDIO:PREDICT + #drop
                            GROUP:PREDICT + 
                            AUDIO:GROUP + #keep
                            VIDEO:GROUP + #keep
                            VIDEO:PREDICT + #keep
                            
                            AUDIO +
                            VIDEO +
                            PREDICT +
                            GROUP + 
                            TRIAL_c +
                               
                            (1|SUBJECT)+
                            (1|ITEM),
                          
                           family = binomial("logit"), 
                           data=data,                      
                           control=glmerControl(optimizer="bobyqa", 
                           optCtrl=list(maxfun=2e5),
                           calc.derivs=FALSE), 
                           na.action=na.omit)
anova(glm.3, glm.7) #n.s. drop

glm.8 <- glmer(ACC ~ 
                            #AUDIO:VIDEO + #drop
                            #AUDIO:PREDICT + #drop
                            #GROUP:PREDICT + drop
                            AUDIO:GROUP + #keep
                            VIDEO:GROUP + #keep
                            VIDEO:PREDICT + #keep
                            
                            AUDIO +
                            VIDEO +
                            PREDICT +
                            GROUP + 
                            TRIAL_c +
                               
                            (1|SUBJECT)+
                            (1|ITEM),
                          
                           family = binomial("logit"), 
                           data=data,                      
                           control=glmerControl(optimizer="bobyqa", 
                           optCtrl=list(maxfun=2e5),
                           calc.derivs=FALSE), 
                           na.action=na.omit)
anova(glm.7, glm.8) #n.s. drop group:predict
summary(glm.8)

glm.9 <- glmer(ACC ~ 
                            #AUDIO:VIDEO + #drop
                            #AUDIO:PREDICT + #drop
                            #GROUP:PREDICT + drop
                            #AUDIO:GROUP + #drop
                            VIDEO:GROUP + #keep
                            VIDEO:PREDICT + #keep
                            
                            AUDIO +
                            VIDEO +
                            PREDICT +
                            GROUP + 
                            TRIAL_c +
                               
                            (1|SUBJECT)+
                            (1|ITEM),
                          
                           family = binomial("logit"), 
                           data=data,                      
                           control=glmerControl(optimizer="bobyqa", 
                           optCtrl=list(maxfun=2e5),
                           calc.derivs=FALSE), 
                           na.action=na.omit)
anova(glm.8, glm.9) #n.s. drop audio group

# check re-introduced slopes
glm.10 <- glmer(ACC ~ 
                            #AUDIO:VIDEO + #drop
                            #AUDIO:PREDICT + #drop
                            #GROUP:PREDICT + drop
                            #AUDIO:GROUP + #drop
                            VIDEO:GROUP + #keep
                            VIDEO:PREDICT + #keep
                            
                            AUDIO +
                            VIDEO +
                            PREDICT +
                            GROUP + 
                            TRIAL_c +
                               
                            (1+PREDICT|SUBJECT)+
                            (1|ITEM),
                          
                           family = binomial("logit"), 
                           data=data,                      
                           control=glmerControl(optimizer="bobyqa", 
                           optCtrl=list(maxfun=2e5),
                           calc.derivs=FALSE), 
                           na.action=na.omit)
anova(glm.9, glm.10) #n.s. predict slope

glm.11 <- glmer(ACC ~ 
                            #AUDIO:VIDEO + #drop
                            #AUDIO:PREDICT + #drop
                            #GROUP:PREDICT + drop
                            #AUDIO:GROUP + #drop
                            VIDEO:GROUP + #keep
                            VIDEO:PREDICT +
                            
                            AUDIO +
                            VIDEO +
                            PREDICT +
                            GROUP + 
                            #TRIAL_c + #drop
                               
                            (1|SUBJECT)+
                            (1|ITEM),
                          
                           family = binomial("logit"), 
                           data=data,                      
                           control=glmerControl(optimizer="bobyqa", 
                           optCtrl=list(maxfun=2e5),
                           calc.derivs=FALSE), 
                           na.action=na.omit)
anova(glm.9, glm.11) #n.s. drop trial
summary(glm.11)

glm.12 <- glmer(ACC ~ 
                            #AUDIO:VIDEO + #drop
                            #AUDIO:PREDICT + #drop
                            #GROUP:PREDICT + drop
                            #AUDIO:GROUP + #drop
                            VIDEO:GROUP + #keep
                            #VIDEO:PREDICT + #keep
                            
                            AUDIO +
                            VIDEO +
                            PREDICT +
                            GROUP + 
                            #TRIAL_c + #drop
                               
                            (1|SUBJECT)+
                            (1|ITEM),
                          
                           family = binomial("logit"), 
                           data=data,                      
                           control=glmerControl(optimizer="bobyqa", 
                           optCtrl=list(maxfun=2e5),
                           calc.derivs=FALSE), 
                           na.action=na.omit)
anova(glm.11, glm.12) #sig., keep
```

# Optimized with random slopes

Since the model converges, we opted for a slightly larger random slope structure. NB that effects with and without random slopes are effectively the same! 

```{r}
glm.optimized <- glmer(ACC ~ 
                            VIDEO:GROUP + #keep
                            VIDEO:PREDICT + #keep
                            AUDIO +
                            VIDEO +
                            PREDICT +
                            GROUP + 
                               
                            (1+PREDICT|SUBJECT)+
                            (1+VIDEO|ITEM),
                          
                           family = binomial("logit"), 
                           data=data,                      
                           control=glmerControl(optimizer="bobyqa", 
                           optCtrl=list(maxfun=2e5),
                           calc.derivs=FALSE), 
                           na.action=na.omit)


# for comparison: random effects reduced:
glm.optimized.intercept <- glmer(ACC ~ 
                            VIDEO:GROUP + #keep
                            VIDEO:PREDICT + #keep
                            
                            AUDIO +
                            VIDEO +
                            PREDICT +
                            GROUP + 
                               
                            (1|SUBJECT)+
                            (1|ITEM),
                          
                           family = binomial("logit"), 
                           data=data,                      
                           control=glmerControl(optimizer="bobyqa", 
                           optCtrl=list(maxfun=2e5),
                           calc.derivs=FALSE), 
                           na.action=na.omit)

summary(glm.optimized)
summary(glm.optimized.intercept)

```

# The final accuracy model


Below is the model reported in the paper. 

```{r}
tab_model(glm.optimized,pred.labels = c("Intercept","Acoustic Mask","Visual Mask","Cloze Probability","Age Group","Visual Mask * Age Group", "Visual Mask * Cloze Probability"),
          file = "figure/220204logistic.html")
webshot("figure/220204logistic.html", "figure/220204logistic.png")
```

```{r model inspection}
vif(glm.optimized) 
check_overdispersion(glm.optimized) 
check_singularity(glm.optimized) 
sum(abs(resid(glm.optimized, scaled = TRUE)) > 3) / length(resid(glm.optimized)) 
tab_model(glm.optimized)
```

# Post-hoc comparisons

```{r}
#emmip(data, ...) 
#emmeans(data, pairwise~..., by="...")

emmeans(glm.optimized, pairwise~VIDEO|GROUP, p.adjust.method = "bonferroni")
plot(allEffects(glm.optimized))
```


## Subsets

```{r subsets, include=TRUE}

adults <- subset(data, data$group == 'a') #3003
summary(adults$AGE)
contrasts(adults$AUDIO) #contrasts are kept in subsets

children <- subset(data, data$group == 'c') #2943
summary(children$AGE)

```
# Adults
```{r group}
glm.adults.complex <- glmer(ACC ~ 
                            
                            AUDIO +
                            VIDEO +
                            PREDICT +
                               
                            (1+PREDICT|SUBJECT)+ #+VIDEO taken out
                            (1+VIDEO|ITEM), #AUDIO+ taken out
                          
                           family = binomial("logit"), 
                           data=adults,                      
                           control=glmerControl(optimizer="bobyqa", 
                           optCtrl=list(maxfun=2e5),
                           calc.derivs=FALSE), 
                           na.action=na.omit)
tab_model(glm.adults.complex)
plot(allEffects(glm.adults.complex))

```
# Children
```{r group}
glm.children.complex <- glmer(ACC ~ 
                            
                            AUDIO +
                            VIDEO +
                            PREDICT +
                               
                            (1+PREDICT|SUBJECT)+ #+VIDEO taken out
                            (1+VIDEO|ITEM), #AUDIO+ taken out
                          
                           family = binomial("logit"), 
                           data=children,                      
                           control=glmerControl(optimizer="bobyqa", 
                           optCtrl=list(maxfun=2e5),
                           calc.derivs=FALSE), 
                           na.action=na.omit)
tab_model(glm.children.complex)
plot(allEffects(glm.children.complex))

```


### Jasper's code

Logistic regression

```{r}
#Releveling
acc_data_all$CONDITION<-relevel(as.factor(acc_data_all$CONDITION), "aNMvNM") # using aNMvNM as reference
acc_data_all$GROUP<-relevel(as.factor(acc_data_all$GROUP), "Adults") # using Adults as reference
acc_data_all$PREDICT<-relevel(as.factor(acc_data_all$PREDICT), "L") # using L as reference


###Modelling
###
###

# MODEL1: Fixed = full; Rand = intercepts only

mask_acc_fullfix<-glmer(ACC~CONDITION+GROUP+PREDICT+
                          CONDITION:GROUP+
                          GROUP:PREDICT+
                          PREDICT:CONDITION+
                          (1|SUBJECT)+(1|ITEM), family = binomial("logit"),data=acc_data_all,control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5),calc.derivs=FALSE))
tab_model(mask_acc_fullfix)


# Selection
drop1(mask_acc_fullfix, test="Chisq") 
# Condition:group no
# Group:predict no
# Condition:predict yes

# MODEL2: Fixed = reduced; Rand = intercepts only

mask_acc_redfixed<-glmer(ACC~CONDITION+GROUP+PREDICT+CONDITION:PREDICT+(1|SUBJECT)+(1|ITEM), family = binomial("logit"),data=acc_data_all,control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5),calc.derivs=FALSE))

tab_model(mask_acc_redfixed)

# MODEL3 (Final): Fixed = reduced; Rand = maximal (By-subject slopes for condition and predict cause persistent singularity. By-item slope for predict not added because items already differ by predict)

mask_acc_redmax<-glmer(ACC~CONDITION+GROUP+PREDICT+CONDITION:PREDICT+(1+PREDICT|SUBJECT)+(1+GROUP+CONDITION|ITEM), family = binomial("logit"),data=acc_data_all,control=glmerControl(optimizer="Nelder_Mead",optCtrl=list(maxfun=2e5),calc.derivs=FALSE))

# Some model diagnostics
vif(mask_acc_redmax) #pass (look at GVIF values on right; all below 2)
check_overdispersion(mask_acc_redmax) #pass (not sig)
check_singularity(mask_acc_redmax) #pass (i.e. not singular)
sum(abs(resid(mask_acc_redmax, scaled = TRUE)) > 3) / length(resid(mask_acc_redmax)) # few outliers, all passed
tab_model(mask_acc_redmax)

#### POST-HOC
####
####

emmip(mask_acc_redmax, ~CONDITION*PREDICT) 
emmeans(mask_acc_redmax, pairwise~CONDITION, by="PREDICT") # averaged over group, since interaction of group is not sig

# summary = audio mask causes more accurary problem than video masks

```

