---
title: "PerMaSC accuracy"
author: "Jasper Sim Hong" ; edited by: "Julia Schwarz"
date: "15/01/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages, include=FALSE}

library(ggplot2)
library(dplyr)
library(tidyr)
library(lmerTest)
library(lme4)
library(performance)
library(sjPlot)
library(jtools)
library(car)
library(emmeans)

options(scipen = 100)
```

## Data

```{r data}
data<-read.delim("220117_errordata.txt", sep="\t", header=T)
table(data$ACC) 
168/(5778+168) # error rate
```

## Variable Prep

```{r variables, echo=FALSE}
# Random 
data$SUBJECT <- as.factor(data$SUBJECT)
data$ITEM <- as.factor(data$ITEM) #this represents the different sentences (H & L), NOT the different targets

# Outcome Var
data$ACC <- as.factor(data$ACC) #1==correct

# RT
data$RT <- as.numeric(data$RT) #RT from the end of the sentence
data$RT_z <- scale(data$RT, center = TRUE, scale = TRUE)

# Fixed Main Effects
data$AUDIO <- factor(data$AUDIO, levels=c("aNM","aM"))
data$VIDEO <- factor(data$VIDEO, levels = c("vNM", "vM"))
data$PREDICT <- factor(data$PREDICT, levels = c("H", "L"))
data$AGE <- as.numeric(data$AGE)
data$AGE <- round(data$AGE, digits = 2)
data$TRIAL <- as.numeric(data$TRIAL)
data$GROUP <- as.factor(data$GROUP) #adults vs children

# Fixed Effects Contrast Coded
contrasts(data$AUDIO) <- contr.sum(2)
contrasts(data$AUDIO)
contrasts(data$VIDEO) <- contr.sum(2)
contrasts(data$VIDEO)
contrasts(data$PREDICT) <- contr.sum(2)
contrasts(data$PREDICT)
contrasts(data$GROUP) <- contr.sum(2)
contrasts(data$GROUP)

# Fixed Effects Centered; "if in doubt, center"
data$AGE_c <- scale(data$AGE, scale = FALSE, center = TRUE)
data$TRIAL_c <- scale(data$TRIAL, scale = FALSE, center = TRUE)

# Other
data$CONDITION <- as.factor(data$CONDITION)
data$BLOCK <- as.factor(data$BLOCK)
data$LIST <- as.factor(data$LIST)
data$SEX <- as.factor(data$sex)
```

# Summary statistics
```{r}
# With group_by(GROUP) or not
data %>%
  group_by(GROUP,AUDIO,VIDEO,PREDICT) %>%
  summarise(n=n(),error_condition = round(((1- sum(accuracy)/n())*100),2))

data %>%
  group_by(GROUP) %>%
  summarise(n=n(),error_condition = round(((1- sum(accuracy)/n())*100),2))

```
```{r checking token numbers}
# For checking data loss
parlist <- unique(data$parid)
# dput(as.character(parlist)) 
# Using python files to locate
tab1 <- read.delim("checkingtokennum/processed_step1.txt", sep = "\t", header = T)
tab2 <- read.delim("checkingtokennum/processed_step2.txt", sep = "\t", header = T)
# Tab 1 missing c79 - but tab1 is not very informational anyway, so let's skip it.
original = sum(tab2$num_of_intervals) # 6557
# How many deleted because of practice trial or special trials?
# How many are repetitive?
final = nrow(data) # 5946


nrow(tab2) #52 OK!
nrow(data)
6557 - 5946

```



# Full Start Model

# Removed stepwise to allow computation: Video by subject random slope, by item audio slope

```{r group}
glm.complex <- glmer(ACC ~ 
                            AUDIO:VIDEO +
                            AUDIO:PREDICT +
                            GROUP:PREDICT + 
                            AUDIO:GROUP +
                            VIDEO:GROUP +
                            VIDEO:PREDICT +
                            
                            AUDIO +
                            VIDEO +
                            PREDICT +
                            GROUP + 
                            TRIAL_c +
                               
                            (1+PREDICT|SUBJECT)+ #+VIDEO taken out
                            (1+VIDEO|ITEM), #AUDIO+ taken out
                          
                           family = binomial("logit"), 
                           data=data,                      
                           control=glmerControl(optimizer="bobyqa", 
                           optCtrl=list(maxfun=2e5),
                           calc.derivs=FALSE), 
                           na.action=na.omit)
summary(glm.complex)
```

```{r optimize, include=FALSE}
glm.1 <- glmer(ACC ~ 
                            AUDIO:VIDEO +
                            AUDIO:PREDICT +
                            GROUP:PREDICT + 
                            AUDIO:GROUP +
                            VIDEO:GROUP +
                            VIDEO:PREDICT +
                            
                            AUDIO +
                            VIDEO +
                            PREDICT +
                            GROUP + 
                            TRIAL_c +
                               
                            (1+PREDICT|SUBJECT)+ #+VIDEO taken out
                            (1|ITEM), #AUDIO+ taken out #VIDEO
                          
                           family = binomial("logit"), 
                           data=data,                      
                           control=glmerControl(optimizer="bobyqa", 
                           optCtrl=list(maxfun=2e5),
                           calc.derivs=FALSE), 
                           na.action=na.omit)
anova(glm.complex, glm.1) # no significant difference after simplifying the random slope

glm.2 <- glmer(ACC ~ 
                            AUDIO:VIDEO +
                            AUDIO:PREDICT +
                            GROUP:PREDICT + 
                            AUDIO:GROUP +
                            VIDEO:GROUP +
                            VIDEO:PREDICT +
                            
                            AUDIO +
                            VIDEO +
                            PREDICT +
                            GROUP + 
                            TRIAL_c +
                               
                            (1|SUBJECT)+ #PREDICT simplified
                            (1|ITEM), #taken out #VIDEO
                          
                           family = binomial("logit"), 
                           data=data,                      
                           control=glmerControl(optimizer="bobyqa", 
                           optCtrl=list(maxfun=2e5),
                           calc.derivs=FALSE), 
                           na.action=na.omit)
anova(glm.1, glm.2) # no sig. difference
```

```{r optimized glm}
glm.3 <- glmer(ACC ~ 
                            #AUDIO:VIDEO +
                            AUDIO:PREDICT +
                            GROUP:PREDICT + 
                            AUDIO:GROUP +
                            VIDEO:GROUP +
                            VIDEO:PREDICT +
                            
                            AUDIO +
                            VIDEO +
                            PREDICT +
                            GROUP + 
                            TRIAL_c +
                               
                            (1|SUBJECT)+
                            (1|ITEM),
                          
                           family = binomial("logit"), 
                           data=data,                      
                           control=glmerControl(optimizer="bobyqa", 
                           optCtrl=list(maxfun=2e5),
                           calc.derivs=FALSE), 
                           na.action=na.omit)
anova(glm.2, glm.3) #no dif.

glm.4 <- glmer(ACC ~ 
                            #AUDIO:VIDEO +
                            AUDIO:PREDICT +
                            GROUP:PREDICT + 
                            #AUDIO:GROUP +
                            VIDEO:GROUP +
                            VIDEO:PREDICT +
                            
                            AUDIO +
                            VIDEO +
                            PREDICT +
                            GROUP + 
                            TRIAL_c +
                               
                            (1|SUBJECT)+
                            (1|ITEM),
                          
                           family = binomial("logit"), 
                           data=data,                      
                           control=glmerControl(optimizer="bobyqa", 
                           optCtrl=list(maxfun=2e5),
                           calc.derivs=FALSE), 
                           na.action=na.omit)
anova(glm.3, glm.4) #sig. -> keep Audio:Group

glm.5 <- glmer(ACC ~ 
                            #AUDIO:VIDEO + #drop
                            AUDIO:PREDICT +
                            GROUP:PREDICT + 
                            AUDIO:GROUP + #keep
                            #VIDEO:GROUP +
                            VIDEO:PREDICT +
                            
                            AUDIO +
                            VIDEO +
                            PREDICT +
                            GROUP + 
                            TRIAL_c +
                               
                            (1|SUBJECT)+
                            (1|ITEM),
                          
                           family = binomial("logit"), 
                           data=data,                      
                           control=glmerControl(optimizer="bobyqa", 
                           optCtrl=list(maxfun=2e5),
                           calc.derivs=FALSE), 
                           na.action=na.omit)
anova(glm.3, glm.5) #sig. -> keep video:group

glm.6 <- glmer(ACC ~ 
                            #AUDIO:VIDEO + #drop
                            AUDIO:PREDICT +
                            GROUP:PREDICT + 
                            AUDIO:GROUP + #keep
                            VIDEO:GROUP + #keep
                            #VIDEO:PREDICT + #keep
                            
                            AUDIO +
                            VIDEO +
                            PREDICT +
                            GROUP + 
                            TRIAL_c +
                               
                            (1|SUBJECT)+
                            (1|ITEM),
                          
                           family = binomial("logit"), 
                           data=data,                      
                           control=glmerControl(optimizer="bobyqa", 
                           optCtrl=list(maxfun=2e5),
                           calc.derivs=FALSE), 
                           na.action=na.omit)
anova(glm.3, glm.6) #sig. -> keep video:predict

glm.7 <- glmer(ACC ~ 
                            #AUDIO:VIDEO + #drop
                            #AUDIO:PREDICT + #drop
                            GROUP:PREDICT + 
                            AUDIO:GROUP + #keep
                            VIDEO:GROUP + #keep
                            VIDEO:PREDICT + #keep
                            
                            AUDIO +
                            VIDEO +
                            PREDICT +
                            GROUP + 
                            TRIAL_c +
                               
                            (1|SUBJECT)+
                            (1|ITEM),
                          
                           family = binomial("logit"), 
                           data=data,                      
                           control=glmerControl(optimizer="bobyqa", 
                           optCtrl=list(maxfun=2e5),
                           calc.derivs=FALSE), 
                           na.action=na.omit)
anova(glm.3, glm.7) #n.s. drop

glm.8 <- glmer(ACC ~ 
                            #AUDIO:VIDEO + #drop
                            #AUDIO:PREDICT + #drop
                            #GROUP:PREDICT + drop
                            AUDIO:GROUP + #keep
                            VIDEO:GROUP + #keep
                            VIDEO:PREDICT + #keep
                            
                            AUDIO +
                            VIDEO +
                            PREDICT +
                            GROUP + 
                            TRIAL_c +
                               
                            (1|SUBJECT)+
                            (1|ITEM),
                          
                           family = binomial("logit"), 
                           data=data,                      
                           control=glmerControl(optimizer="bobyqa", 
                           optCtrl=list(maxfun=2e5),
                           calc.derivs=FALSE), 
                           na.action=na.omit)
anova(glm.7, glm.8) #n.s. drop group:predict
summary(glm.8)

glm.9 <- glmer(ACC ~ 
                            #AUDIO:VIDEO + #drop
                            #AUDIO:PREDICT + #drop
                            #GROUP:PREDICT + drop
                            #AUDIO:GROUP + #drop
                            VIDEO:GROUP + #keep
                            VIDEO:PREDICT + #keep
                            
                            AUDIO +
                            VIDEO +
                            PREDICT +
                            GROUP + 
                            TRIAL_c +
                               
                            (1|SUBJECT)+
                            (1|ITEM),
                          
                           family = binomial("logit"), 
                           data=data,                      
                           control=glmerControl(optimizer="bobyqa", 
                           optCtrl=list(maxfun=2e5),
                           calc.derivs=FALSE), 
                           na.action=na.omit)
anova(glm.8, glm.9) #n.s. drop audio group

# check re-introduced slopes
glm.10 <- glmer(ACC ~ 
                            #AUDIO:VIDEO + #drop
                            #AUDIO:PREDICT + #drop
                            #GROUP:PREDICT + drop
                            #AUDIO:GROUP + #drop
                            VIDEO:GROUP + #keep
                            VIDEO:PREDICT + #keep
                            
                            AUDIO +
                            VIDEO +
                            PREDICT +
                            GROUP + 
                            TRIAL_c +
                               
                            (1+PREDICT|SUBJECT)+
                            (1|ITEM),
                          
                           family = binomial("logit"), 
                           data=data,                      
                           control=glmerControl(optimizer="bobyqa", 
                           optCtrl=list(maxfun=2e5),
                           calc.derivs=FALSE), 
                           na.action=na.omit)
anova(glm.9, glm.10) #n.s. predict slope

glm.11 <- glmer(ACC ~ 
                            #AUDIO:VIDEO + #drop
                            #AUDIO:PREDICT + #drop
                            #GROUP:PREDICT + drop
                            #AUDIO:GROUP + #drop
                            VIDEO:GROUP + #keep
                            VIDEO:PREDICT +
                            
                            AUDIO +
                            VIDEO +
                            PREDICT +
                            GROUP + 
                            #TRIAL_c + #drop
                               
                            (1|SUBJECT)+
                            (1|ITEM),
                          
                           family = binomial("logit"), 
                           data=data,                      
                           control=glmerControl(optimizer="bobyqa", 
                           optCtrl=list(maxfun=2e5),
                           calc.derivs=FALSE), 
                           na.action=na.omit)
anova(glm.9, glm.11) #n.s. drop trial
summary(glm.11)

glm.12 <- glmer(ACC ~ 
                            #AUDIO:VIDEO + #drop
                            #AUDIO:PREDICT + #drop
                            #GROUP:PREDICT + drop
                            #AUDIO:GROUP + #drop
                            VIDEO:GROUP + #keep
                            #VIDEO:PREDICT + #keep
                            
                            AUDIO +
                            VIDEO +
                            PREDICT +
                            GROUP + 
                            #TRIAL_c + #drop
                               
                            (1|SUBJECT)+
                            (1|ITEM),
                          
                           family = binomial("logit"), 
                           data=data,                      
                           control=glmerControl(optimizer="bobyqa", 
                           optCtrl=list(maxfun=2e5),
                           calc.derivs=FALSE), 
                           na.action=na.omit)
anova(glm.11, glm.12) #sig., keep
```

# Optimized with random slopes

Since the model converges, we opted for a slightly larger random slope structure. NB that effects with and without random slopes are effectively the same! 

```{r}
glm.optimized <- glmer(ACC ~ 
                            VIDEO:GROUP + #keep
                            VIDEO:PREDICT + #keep
                            
                            AUDIO +
                            VIDEO +
                            PREDICT +
                            GROUP + 
                               
                            (1+PREDICT|SUBJECT)+
                            (1+VIDEO|ITEM),
                          
                           family = binomial("logit"), 
                           data=data,                      
                           control=glmerControl(optimizer="bobyqa", 
                           optCtrl=list(maxfun=2e5),
                           calc.derivs=FALSE), 
                           na.action=na.omit)


# for comparison: random effects reduced:
glm.optimized.intercept <- glmer(ACC ~ 
                            VIDEO:GROUP + #keep
                            VIDEO:PREDICT + #keep
                            
                            AUDIO +
                            VIDEO +
                            PREDICT +
                            GROUP + 
                               
                            (1|SUBJECT)+
                            (1|ITEM),
                          
                           family = binomial("logit"), 
                           data=data,                      
                           control=glmerControl(optimizer="bobyqa", 
                           optCtrl=list(maxfun=2e5),
                           calc.derivs=FALSE), 
                           na.action=na.omit)

summary(glm.optimized)
summary(glm.optimized.intercept)

```

# The final accuracy model

Below is the model reported in the paper. 

```{r}
tab_model(glm.optimized)
```

```{r model inspection}
vif(glm.optimized) 
check_overdispersion(glm.optimized) 
check_singularity(glm.optimized) 
sum(abs(resid(glm.optimized, scaled = TRUE)) > 3) / length(resid(glm.optimized)) 
tab_model(glm.optimized)
```

# Post-hoc comparisons

```{r}
#emmip(data, ...) 
#emmeans(data, pairwise~..., by="...")
```





### Jasper's code

Logistic regression

```{r}
#Releveling
acc_data_all$CONDITION<-relevel(as.factor(acc_data_all$CONDITION), "aNMvNM") # using aNMvNM as reference
acc_data_all$GROUP<-relevel(as.factor(acc_data_all$GROUP), "Adults") # using Adults as reference
acc_data_all$PREDICT<-relevel(as.factor(acc_data_all$PREDICT), "L") # using L as reference


###Modelling
###
###

# MODEL1: Fixed = full; Rand = intercepts only

mask_acc_fullfix<-glmer(ACC~CONDITION+GROUP+PREDICT+
                          CONDITION:GROUP+
                          GROUP:PREDICT+
                          PREDICT:CONDITION+
                          (1|SUBJECT)+(1|ITEM), family = binomial("logit"),data=acc_data_all,control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5),calc.derivs=FALSE))
tab_model(mask_acc_fullfix)


# Selection
drop1(mask_acc_fullfix, test="Chisq") 
# Condition:group no
# Group:predict no
# Condition:predict yes

# MODEL2: Fixed = reduced; Rand = intercepts only

mask_acc_redfixed<-glmer(ACC~CONDITION+GROUP+PREDICT+CONDITION:PREDICT+(1|SUBJECT)+(1|ITEM), family = binomial("logit"),data=acc_data_all,control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5),calc.derivs=FALSE))

tab_model(mask_acc_redfixed)

# MODEL3 (Final): Fixed = reduced; Rand = maximal (By-subject slopes for condition and predict cause persistent singularity. By-item slope for predict not added because items already differ by predict)

mask_acc_redmax<-glmer(ACC~CONDITION+GROUP+PREDICT+CONDITION:PREDICT+(1+PREDICT|SUBJECT)+(1+GROUP+CONDITION|ITEM), family = binomial("logit"),data=acc_data_all,control=glmerControl(optimizer="Nelder_Mead",optCtrl=list(maxfun=2e5),calc.derivs=FALSE))

# Some model diagnostics
vif(mask_acc_redmax) #pass (look at GVIF values on right; all below 2)
check_overdispersion(mask_acc_redmax) #pass (not sig)
check_singularity(mask_acc_redmax) #pass (i.e. not singular)
sum(abs(resid(mask_acc_redmax, scaled = TRUE)) > 3) / length(resid(mask_acc_redmax)) # few outliers, all passed
tab_model(mask_acc_redmax)

#### POST-HOC
####
####

emmip(mask_acc_redmax, ~CONDITION*PREDICT) 
emmeans(mask_acc_redmax, pairwise~CONDITION, by="PREDICT") # averaged over group, since interaction of group is not sig

# summary = audio mask causes more accurary problem than video masks

```

